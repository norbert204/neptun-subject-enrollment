{{- if .Values.scylla.schemaInit.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: scylla-schema-init
  labels:
    app.kubernetes.io/name: scylla-schema-init
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: {{ .Values.scylla.schemaInit.backoffLimit | default 10 }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: scylla-schema-init
        app.kubernetes.io/instance: {{ .Release.Name }}
    spec:
      restartPolicy: OnFailure
      containers:
        - name: schema-init
          image: "{{ .Values.scylla.image.repository }}:{{ .Values.scylla.image.tag }}"
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Waiting for Scylla to be ready..."
              
              # Wait for Scylla to accept connections (retry up to 60 times, 5s each = 5min)
              for i in {1..60}; do
                if cqlsh {{ .Values.scylla.schemaInit.host | default "scylla" }} -e "DESCRIBE KEYSPACES" > /dev/null 2>&1; then
                  echo "Scylla is ready!"
                  break
                fi
                echo "Attempt $i: Scylla not ready yet, retrying in 5s..."
                sleep 5
              done
              
              # Run the schema initialization
              echo "Creating keyspace and tables..."
              cqlsh {{ .Values.scylla.schemaInit.host | default "scylla" }} <<'EOF'
              CREATE KEYSPACE IF NOT EXISTS {{ .Values.cassandra.keyspace }} 
                WITH replication = {'class': 'SimpleStrategy', 'replication_factor': {{ .Values.scylla.schemaInit.replicationFactor | default 1 }}};

              USE {{ .Values.cassandra.keyspace }};

              CREATE TABLE IF NOT EXISTS users (
                  neptun_code text PRIMARY KEY,
                  name text,
                  email text,
                  password text
              );

              CREATE TABLE IF NOT EXISTS subjects (
                  id text PRIMARY KEY,
                  owner text,
                  name text,
                  prerequisites list<text>,
                  courses list<text>
              );

              CREATE TABLE IF NOT EXISTS courses (
                  id text PRIMARY KEY,
                  room text,
                  start_time text,
                  end_time text,
                  capacity int,
                  enrolled_students list<text>,
                  course_type text
              );
              EOF
              
              echo "Schema initialization completed successfully!"
{{- end }}
